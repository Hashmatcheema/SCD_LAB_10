pipeline {
    agent any
    
    stages {
        stage('Checkout Code') {
            steps {
                script {
                    // Get build information
                    def buildNumber = env.BUILD_NUMBER
                    def timestamp = new Date().format("yyyy-MM-dd HH:mm:ss")
                    
                    // Check if triggered by GitHub webhook
                    def isWebhookTrigger = false
                    def causes = currentBuild.getBuildCauses()
                    
                    // Check various webhook trigger causes
                    for (cause in causes) {
                        def causeClass = cause.getClass().toString()
                        if (causeClass.contains('GitHubPushCause') || 
                            causeClass.contains('RemoteCause') ||
                            causeClass.contains('GitHubHookCause')) {
                            isWebhookTrigger = true
                            break
                        }
                    }
                    
                    // Also check environment variables
                    if (!isWebhookTrigger) {
                        if (env.GITHUB_WEBHOOK || env.BUILD_CAUSE?.contains('GitHub') || env.BUILD_CAUSE?.contains('Remote')) {
                            isWebhookTrigger = true
                        }
                    }
                    
                    // Display build information
                    echo "=========================================="
                    echo "Build #${buildNumber} triggered at ${timestamp}"
                    if (isWebhookTrigger) {
                        echo "Triggered by GitHub Webhook"
                    } else {
                        def user = env.BUILD_USER ?: env.CHANGE_AUTHOR ?: 'user'
                        echo "Triggered manually by ${user}"
                    }
                    echo "=========================================="
                }
                checkout scm
            }
        }
        stage('Install Dependencies') {
            steps {
                dir('Task1') {
                    bat 'npm install'
                }
            }
        }
        stage('Run Tests') {
            steps {
                dir('Task1') {
                    bat 'npm test'
                }
            }
        }
    }
    
    post {
        success {
            echo 'Build and tests successful!'
        }
        failure {
            echo 'Build failed or tests failed!'
        }
    }
}
